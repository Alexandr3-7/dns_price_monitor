# dns_price_monitor
# Мониторинг Цен DNS с Уведомлениями в Telegram и Веб-Интерфейсом

Этот проект представляет собой Python-скрипт для автоматического отслеживания цен на товары на сайте `dns-shop.ru`. Он использует Selenium и `undetected-chromedriver` для парсинга цен, сохраняет историю изменений и уведомляет об изменениях через Telegram-бота. Также имеется веб-интерфейс на Flask для просмотра статуса и управления списком отслеживаемых URL.

## Основные Возможности

*   **Мониторинг цен:** Периодически проверяет цены на заданные товары DNS.
*   **Парсинг актуальной цены:** Использует точный CSS-селектор и JavaScript для извлечения текущей цены, стараясь игнорировать зачеркнутые/старые цены.
*   **Обход базовой защиты:** Применяет `undetected-chromedriver` для имитации обычного браузера.
*   **Уведомления в Telegram:** Отправляет сообщения в Telegram при обнаружении изменения цены.
*   **Управление через Telegram:**
    *   Добавление/удаление URL для мониторинга.
    *   Просмотр текущего статуса и цен отслеживаемых товаров.
    *   Просмотр списка отслеживаемых URL.
    *   Подписка/отписка пользователей (с ограничением).
*   **Веб-интерфейс:**
    *   Визуальное отображение отслеживаемых товаров, их цен, истории и статуса последней проверки.
    *   Форма для добавления новых URL.
    *   Кнопки для удаления URL.
*   **Параллельный парсинг:** Использует `ThreadPoolExecutor` для одновременной проверки нескольких URL (количество настраивается).
*   **История цен:** Сохраняет историю изменений цен для каждого товара в файле `price_history.json`.
*   **Управление URL и Пользователями:** Списки URL и ID пользователей Telegram хранятся в файлах `urls.json` и `telegram_users.json`.
*   **Имитация пользователя:** Опционально включает случайные скроллы и движения мыши для большей реалистичности.
*   **Логирование:** Ведет журнал событий и ошибок.

## Предварительные требования

*   **Python:** Версия 3.9 или выше.
*   **pip:** Установщик пакетов Python (обычно идет вместе с Python).
*   **Google Chrome / Chromium:** Установленный в системе браузер Chrome или Chromium. `undetected-chromedriver` будет автоматически скачивать совместимый `chromedriver`.
*   **Git** (опционально, для клонирования репозитория).
*   **(Для работы через Tor - НЕ в текущей версии)** Установленный и запущенный Tor (служба или Tor Browser).

## Установка

1.  **Клонировать репозиторий (если используете Git):**
    ```bash
    git clone <URL_вашего_репозитория>
    cd <имя_папки_репозитория>
    ```
    Или просто скачайте и распакуйте файлы проекта в нужную папку.

2.  **Создать и активировать виртуальное окружение (рекомендуется):**
    ```bash
    # Создать окружение
    python -m venv venv
    ```
    *   **Windows (PowerShell):**
        ```powershell
        # Разрешить выполнение скриптов для текущей сессии (если требуется)
        Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process
        # Активировать
        .\venv\Scripts\Activate.ps1
        ```
    *   **Windows (cmd.exe):**
        ```cmd
        venv\Scripts\activate.bat
        ```
    *   **Linux / macOS:**
        ```bash
        source venv/bin/activate
        ```
    Вы должны увидеть `(venv)` в начале командной строки.

3.  **Установить зависимости:**
    ```bash
    pip install Flask undetected-chromedriver selenium python-telegram-bot==21.0.1 requests waitress urllib3
    ```
    *Примечание: Используется `python-telegram-bot` версии 21.0.1. Если у вас другая версия, код может потребовать адаптации.*

## Конфигурация

Основная настройка выполняется через константы в начале файла `app.py`:

1.  **`TELEGRAM_BOT_TOKEN` (ОБЯЗАТЕЛЬНО):**
    *   Получите токен у @BotFather в Telegram.
    *   **Замените плейсхолдер `"7359502748:AAHwLgsw7lZ0-dkvNtHj2cFk6m0m-eHtxJY"` на другой токен.** Без этого будет запущен тестовый бот.

2.  **`MAX_WORKERS`:**
    *   Количество одновременно работающих потоков (браузеров) для парсинга.
    *   **Начните с `3` или `4`.** Увеличение этого значения повышает скорость, но требует больше ресурсов (CPU/RAM) и **значительно увеличивает риск блокировки IP-адреса сайтом DNS.** Подбирайте максимальное *стабильное* значение для вашей системы и сети.

3.  **`CHECK_INTERVAL_SECONDS`:**
    *   Пауза в секундах между полными циклами проверки всех URL. Увеличьте значение, если сталкиваетесь с блокировками.

4.  **Селекторы CSS (`MAIN_PRICE_SELECTOR`, `TITLE_SELECTOR`):**
    *   **ВАЖНО:** Сайт DNS может изменить свою структуру. Если парсинг перестает работать (особенно получение цены), в первую очередь проверьте актуальность этих селекторов с помощью Инструментов разработчика (F12) в браузере и обновите их в коде при необходимости. Текущий `MAIN_PRICE_SELECTOR` нацелен на `.product-buy__price_active`.

5.  **Другие настройки:**
    *   `PAGE_LOAD_TIMEOUT`, `ELEMENT_WAIT_TIMEOUT`, `TITLE_WAIT_TIMEOUT`: Таймауты ожидания. Увеличьте, если у вас медленное соединение или сайт долго грузится.
    *   `ENABLE_USER_SIMULATION`: Включить/выключить имитацию действий пользователя.
    *   `USER_AGENTS`: Можно расширить список User-Agent'ов.

## Запуск Приложения

1.  Убедитесь, что Google Chrome/Chromium установлен.
2.  Активируйте виртуальное окружение (см. пункт Установки).
3.  Перейдите в папку проекта в терминале/PowerShell.
4.  Запустите скрипт:
    ```bash
    python app.py
    ```
5.  Скрипт выполнит предварительный патчинг `chromedriver`, инициализирует компоненты и запустит веб-сервер (обычно на `http://0.0.0.0:5000`) и фоновые потоки мониторинга и Telegram-бота. Следите за выводами в консоли.

## Использование

### Веб-интерфейс

*   Откройте в браузере адрес, указанный при запуске (например, `http://localhost:5000` или `http://<IP-адрес_сервера>:5000`).
*   **Просмотр:** Отображает список отслеживаемых товаров, их текущие цены (или ошибки), время последней проверки и историю цен.
*   **Добавление URL:** Вставьте один или несколько URL товаров DNS (каждый на новой строке) в текстовое поле и нажмите "Добавить URL".
*   **Удаление URL:** Нажмите на красный крестик "×" рядом со ссылкой "Перейти к товару", чтобы удалить соответствующий URL из мониторинга.
*   Страница автоматически обновляется (интервал указан внизу).

### Telegram Бот

1.  **Найдите вашего бота** в Telegram (по имени, которое вы ему дали в @BotFather).
2.  **Начните диалог:** Отправьте команду `/start`. Бот должен ответить и (если лимит пользователей не достигнут) добавить вас в список подписчиков. Появится клавиатура с основными командами.
3.  **Используйте команды или кнопки:**
    *   `/status` (📊 Статус): Показывает текущий статус всех отслеживаемых товаров (название, цена/ошибка, время проверки). *Сообщение может быть разбито на части, если список длинный.*
    *   `/list` (📋 Список URL): Показывает полный список URL, которые сейчас отслеживаются. *Сообщение может быть разбито на части.*
    *   `/add` (➕ Добавить URL): Начинает диалог добавления новых URL. Следуйте инструкциям бота.
    *   `/delete` (➖ Удалить URL): Показывает список отслеживаемых товаров с кнопками для удаления. Нажмите на кнопку соответствующего товара.
    *   `/stop` (🛑 Отписаться): Отписывает вас от уведомлений и удаляет ваш ID из списка пользователей. Клавиатура будет убрана.

## Устранение Неисправностей

*   **Блокировка IP:** Если скрипт перестает работать и в логах появляются ошибки `ERR_CONNECTION_TIMED_OUT`, `ConnectionResetError`, `MaxRetryError`, `NewConnectionError`, возможно, ваш IP заблокирован DNS.
    *   **Решение:** Остановите скрипт. Попробуйте перезагрузить роутер для смены IP (если у вас динамический IP). Уменьшите `MAX_WORKERS` до 2-4. Увеличьте `CHECK_INTERVAL_SECONDS` (до 300 и более). Включите `ENABLE_USER_SIMULATION`. Рассмотрите использование качественных резидентных прокси (потребует модификации кода для их интеграции).
*   **Цена не находится (Ошибка `TimeoutException` или `NoSuchElementException` при поиске цены):**
    *   **Решение:** Скорее всего, изменился CSS-селектор на сайте DNS. Проверьте актуальность `MAIN_PRICE_SELECTOR` в `app.py` с помощью Инструментов разработчика (F12) и обновите его. Проверьте также скриншоты ошибок, если они создаются.
*   **Высокое потребление CPU/RAM:**
    *   **Решение:** Уменьшите значение `MAX_WORKERS`.
*   **Ошибки Telegram (`Message is too long`, `Can't parse entities`):**
    *   **Решение:** Код пытается разбивать длинные сообщения, но ошибки все равно возможны, особенно при очень большом количестве URL или наличии специфических символов в названиях. Попробуйте уменьшить количество отслеживаемых URL.
*   **Проблемы с `undetected-chromedriver`:** Иногда после обновлений Chrome или самой библиотеки могут возникать проблемы с патчингом. Проверьте наличие обновлений для `undetected-chromedriver` (`pip install --upgrade undetected-chromedriver`).
*   **Смотрите логи:** Файл `app.py` настроен на вывод логов в консоль. Изучайте сообщения `INFO`, `WARNING` и `ERROR` для диагностики проблем.
